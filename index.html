<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoppborg Validator - EN 14960-1:2019</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="max-w-4xl mx-auto p-4"></div>
    
    <div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="closeModal()">
        <div class="bg-white rounded-lg p-6 max-w-2xl max-h-[90vh] overflow-y-auto mx-4" onclick="event.stopPropagation()">
            <button onclick="closeModal()" class="float-right text-3xl text-gray-500 hover:text-gray-700">&times;</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        const app = {
            data: {
                length: '', width: '', height: '', type: '', productId: '', idVisible: '',
                hasSafetyInstructions: false, hasRopes: '', 
                platformHeight: '', wallHeight: '',
                hasSlide: '', slideHeight: '', runoutLength: '', hasStopWall: false,
                entranceHeight: '', entranceTreadDepth: '',
                blowerTubeLength: '',
                manufacturerMaxUsers: '', manufacturerUserHeight: '',
                anchorA: '', anchorB: '', anchorC: '', anchorD: '', anchorAngle: '', 
                hasNetting: '', nettingMesh: '', nettingCorners: '',
                blowersNeeded: '', blowerPower: '', 
                images: []
            },
            result: null, cameraActive: false, stream: null
        };

        function showInfo(type) {
            const m = document.getElementById('modalContent');
            const modals = {
                height: '<h3 class="font-bold text-lg mb-3">üìè Hur m√§ter man h√∂jd?</h3>' +
                    '<svg viewBox="0 0 200 150" class="w-full max-w-xs border-2 rounded bg-white mb-3">' +
                    '<rect x="20" y="80" width="160" height="60" fill="#e3f2fd" stroke="#2196f3" stroke-width="2"/>' +
                    '<line x1="20" y1="140" x2="180" y2="140" stroke="#000" stroke-width="2"/>' +
                    '<text x="100" y="155" text-anchor="middle" font-size="10">MARK</text>' +
                    '<line x1="10" y1="80" x2="10" y2="140" stroke="#f44336" stroke-width="3"/>' +
                    '<text x="5" y="110" font-size="14" fill="#f44336" font-weight="bold">H</text>' +
                    '<circle cx="100" cy="50" r="20" fill="#ffd700" opacity="0.3"/>' +
                    '<text x="100" y="45" text-anchor="middle" font-size="8">Dekor</text>' +
                    '<text x="100" y="55" text-anchor="middle" font-size="7">(r√§knas EJ)</text>' +
                    '</svg>' +
                    '<p class="text-sm mb-2"><strong class="text-green-600">‚úì R√§tt:</strong> M√§t till v√§ggarnas √∂verkant</p>' +
                    '<p class="text-sm"><strong class="text-red-600">‚úó Fel:</strong> Inkludera dekorationer p√• taket</p>',
                
                annexA: '<h3 class="font-bold text-xl mb-3">üìê Annex A: Ber√§kning av f√§stpunkter</h3>' +
                    '<p class="text-sm mb-3">Varje sida ber√§knas <strong>separat</strong> enligt formeln:</p>' +
                    '<div class="bg-gray-100 p-4 rounded font-mono text-sm mb-3">' +
                    '<p class="mb-2">F = 0.5 √ó 1.5 √ó 1.24 √ó 11.1¬≤ √ó (l√§ngd √ó h√∂jd)</p>' +
                    '<p>n = F √∑ 1,600 <span class="text-red-600 font-bold">(avrunda UPP√ÖT)</span></p>' +
                    '</div>' +
                    '<div class="bg-blue-50 p-3 rounded mb-3 text-sm">' +
                    '<p class="font-semibold mb-2">‚ö†Ô∏è Viktigt:</p>' +
                    '<ul class="list-disc ml-5 space-y-1">' +
                    '<li>H√∂jd = <strong>v√§ggarnas h√∂jd</strong>, inte dekorationer</li>' +
                    '<li>H√∂rnf√§stpunkter r√§knas <strong>50%</strong> p√• varje sida</li>' +
                    '<li>Minimum <strong>6 f√§stpunkter</strong> totalt</li>' +
                    '<li>Vid decimal: avrunda upp√•t (1.1 ‚Üí 2)</li>' +
                    '</ul></div>',
                
                runout: '<h3 class="font-bold text-lg mb-3">üõù Run-out (ut√•kningssektion)</h3>' +
                    '<div class="space-y-2 text-sm bg-blue-50 p-3 rounded">' +
                    '<p class="font-semibold">Krav enligt 4.2.11:</p>' +
                    '<ul class="list-disc ml-5">' +
                    '<li>Min l√§ngd: <strong>50% av slide-h√∂jd</strong> ELLER <strong>300mm</strong></li>' +
                    '<li>Max lutning: <strong>10¬∞</strong></li>' +
                    '<li>Med stoppv√§gg: l√§gg till <strong>+500mm</strong></li>' +
                    '</ul></div>',
                
                corners: '<h3 class="font-bold mb-3">N√§t i h√∂rnen</h3>' +
                    '<svg viewBox="0 0 200 200" class="w-full border-2 rounded mb-3">' +
                    '<rect x="20" y="20" width="160" height="160" fill="#e3f2fd" stroke="#2196f3" stroke-width="2"/>' +
                    '<circle cx="20" cy="20" r="15" fill="none" stroke="#f44336" stroke-width="3"/>' +
                    '<circle cx="180" cy="20" r="15" fill="none" stroke="#f44336" stroke-width="3"/>' +
                    '<circle cx="20" cy="180" r="15" fill="none" stroke="#f44336" stroke-width="3"/>' +
                    '<circle cx="180" cy="180" r="15" fill="none" stroke="#f44336" stroke-width="3"/>' +
                    '<line x1="20" y1="20" x2="60" y2="60" stroke="#4caf50" stroke-width="3"/>' +
                    '<line x1="180" y1="20" x2="140" y2="60" stroke="#4caf50" stroke-width="3"/>' +
                    '<text x="100" y="110" text-anchor="middle" font-weight="bold">N√ÑT M√ÖSTE N√Ö H√ñRNEN</text>' +
                    '</svg>' +
                    '<p class="text-sm">R√∂da cirklar = h√∂rn som m√•ste t√§ckas helt</p>'
            };
            
            m.innerHTML = modals[type] || '';
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function calc() {
            const L = parseFloat(app.data.length) || 0;
            const W = parseFloat(app.data.width) || 0;
            const H = parseFloat(app.data.height) || 0;
            if (!L || !W || !H) return null;

            const calcSide = (area) => {
                const F = 0.5 * 1.5 * 1.24 * 11.1 * 11.1 * area;
                const n = F / 1600;
                return Math.max(Math.ceil(n), 2);
            };

            const anchors = {
                A: { name: 'Sida A', len: L, need: calcSide(L * H) },
                B: { name: 'Sida B (H√∂ger)', len: W, need: calcSide(W * H) },
                C: { name: 'Sida C (Back)', len: L, need: calcSide(L * H) },
                D: { name: 'Sida D (V√§nster)', len: W, need: calcSide(W * H) }
            };

            const minAnchors = Math.max(6, Object.values(anchors).reduce((s, a) => s + a.need, 0));
            const volume = L * W * H;
            const blowersNeeded = Math.ceil(volume / 100);

            const slideH = parseFloat(app.data.slideHeight) || 0;
            const minRunout = Math.max(slideH * 0.5, 0.3);
            const runoutRequired = minRunout + (app.data.hasStopWall ? 0.5 : 0);
            
            const platformH = parseFloat(app.data.platformHeight) || 0;
            const minTreadDepth = platformH * 1.5;

            return { anchors, minAnchors, L, W, blowersNeeded, runoutRequired, minRunout, minTreadDepth };
        }

        function validate() {
            const c = calc();
            if (!c) { alert('Fyll i l√§ngd, bredd och h√∂jd'); return; }

            const issues = [];

            if (app.data.hasRopes === 'yes') issues.push({ severity: 'critical', cat: 'S√§kerhet', msg: 'REP F√ñRBJUDET!', ref: '4.1.4', action: 'Ta bort alla rep omedelbart' });
            if (!app.data.productId) issues.push({ severity: 'critical', cat: 'M√§rkning', msg: 'Produkt-ID saknas', ref: '8', action: 'M√§rk borgen med unikt ID' });
            if (app.data.idVisible === 'no') issues.push({ severity: 'critical', cat: 'M√§rkning', msg: 'ID ej synligt', ref: '8', action: 'Flytta ID s√• det syns' });

            ['A', 'B', 'C', 'D'].forEach(side => {
                const supplied = parseInt(app.data['anchor' + side]) || 0;
                const req = c.anchors[side].need;
                if (supplied > 0 && supplied < req) {
                    issues.push({ severity: 'critical', cat: 'F√∂rankring Sida ' + side, msg: supplied + ' st < ' + req + ' st', ref: 'Annex A', action: 'L√§gg till ' + (req - supplied) + ' f√§stpunkter' });
                }
            });

            const angle = parseInt(app.data.anchorAngle) || 0;
            if (angle > 0 && (angle < 30 || angle > 45)) issues.push({ severity: 'serious', cat: 'F√∂rankring', msg: 'Vinkel ' + angle + '¬∞ (ska vara 30-45¬∞)', ref: '4.2.1', action: 'Justera vinkeln' });

            if (app.data.hasSlide === 'yes') {
                const runoutActual = parseFloat(app.data.runoutLength) || 0;
                if (runoutActual > 0 && runoutActual < c.runoutRequired) {
                    issues.push({ severity: 'critical', cat: 'Slide Run-out', msg: runoutActual + 'm < ' + c.runoutRequired.toFixed(2) + 'm', ref: '4.2.11', action: 'F√∂rl√§ng med ' + (c.runoutRequired - runoutActual).toFixed(2) + 'm' });
                }
            }

            const tubeLen = parseFloat(app.data.blowerTubeLength) || 0;
            if (tubeLen > 0 && tubeLen < 1.2) issues.push({ severity: 'serious', cat: 'Lufttryck', msg: 'Inbl√•sr√∂r ' + tubeLen + 'm < 1.2m', ref: '4.2.4', action: 'Byt till l√§ngre r√∂r' });

            const treadDepth = parseFloat(app.data.entranceTreadDepth) || 0;
            if (treadDepth > 0 && c.minTreadDepth > 0 && treadDepth < c.minTreadDepth) {
                issues.push({ severity: 'serious', cat: 'Ing√•ng', msg: 'Trappdjup ' + treadDepth + 'm < ' + c.minTreadDepth.toFixed(2) + 'm', ref: '4.2.3', action: 'F√∂rl√§ng trappdjupet' });
            }

            if (!app.data.hasSafetyInstructions) issues.push({ severity: 'warning', cat: 'M√§rkning', msg: 'S√§kerhetsinstruktion saknas', ref: '6', action: 'F√§st instruktioner' });

            if (app.data.hasNetting === 'yes') {
                const mesh = parseFloat(app.data.nettingMesh) || 0;
                if (mesh > 8) issues.push({ severity: 'serious', cat: 'N√§t', msg: mesh + 'mm > 8mm', ref: '4.1.3', action: 'Byt n√§t' });
                if (app.data.nettingCorners === 'no') issues.push({ severity: 'serious', cat: 'N√§t', msg: 'N√•r ej h√∂rn', ref: '4.2.9', action: 'Montera korrekt n√§t' });
            }

            const blowers = parseInt(app.data.blowersNeeded) || 0;
            if (blowers > 0 && blowers < c.blowersNeeded) issues.push({ severity: 'serious', cat: 'Lufttryck', msg: blowers + ' < ' + c.blowersNeeded + ' fl√§ktar', ref: '4.2.2', action: 'L√§gg till fl√§ktar' });

            const critical = issues.filter(i => i.severity === 'critical');
            const serious = issues.filter(i => i.severity === 'serious');
            const warnings = issues.filter(i => i.severity === 'warning');

            app.result = { calc: c, issues, critical, serious, warnings, ok: critical.length === 0 && serious.length === 0 };
            localStorage.setItem('hoppborg', JSON.stringify(app));
            render();
        }

        async function startCamera() {
            try {
                app.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                app.cameraActive = true;
                render();
                setTimeout(() => { const v = document.getElementById('cam'); if (v) v.srcObject = app.stream; }, 100);
            } catch (e) { alert('Kamera: ' + e.message); }
        }

        function stopCamera() {
            if (app.stream) { app.stream.getTracks().forEach(t => t.stop()); app.stream = null; }
            app.cameraActive = false;
            render();
        }

        function addImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                app.data.images.push({ data: e.target.result, name: file.name, date: new Date().toISOString() });
                localStorage.setItem('hoppborg', JSON.stringify(app));
                render();
            };
            reader.readAsDataURL(file);
        }

        function removeImage(index) {
            app.data.images.splice(index, 1);
            localStorage.setItem('hoppborg', JSON.stringify(app));
            render();
        }

        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            let y = 20;

            pdf.setFontSize(20); pdf.setTextColor(37, 99, 235);
            pdf.text('Hoppborg Validator', 105, y, { align: 'center' });
            y += 10;
            pdf.setFontSize(10); pdf.setTextColor(100);
            pdf.text('EN 14960-1:2019', 105, y, { align: 'center' });
            y += 15;

            pdf.setFontSize(14); pdf.setTextColor(0);
            pdf.text('Grunduppgifter', 20, y);
            y += 8;
            pdf.setFontSize(10);
            pdf.text('L√§ngd: ' + app.data.length + ' m | Bredd: ' + app.data.width + ' m | H√∂jd: ' + app.data.height + ' m', 20, y);
            y += 6;
            pdf.text('Produkt-ID: ' + (app.data.productId || 'Saknas'), 20, y);
            y += 10;

            if (app.result) {
                pdf.setFontSize(16);
                pdf.setTextColor(app.result.ok ? 34 : 220, app.result.ok ? 197 : 38, app.result.ok ? 94 : 38);
                pdf.text(app.result.ok ? 'GODK√ÑND' : 'UNDERK√ÑND', 20, y);
                y += 10;

                if (app.result.issues.length > 0) {
                    pdf.setFontSize(12); pdf.setTextColor(0);
                    pdf.text('Avvikelser:', 20, y);
                    y += 8;
                    pdf.setFontSize(10);
                    
                    app.result.issues.forEach(issue => {
                        if (y > 270) { pdf.addPage(); y = 20; }
                        const color = issue.severity === 'critical' ? [220, 38, 38] : issue.severity === 'serious' ? [249, 115, 22] : [234, 179, 8];
                        pdf.setTextColor(color[0], color[1], color[2]);
                        pdf.text('‚Ä¢ ' + issue.cat + ': ' + issue.msg, 25, y);
                        y += 5;
                        pdf.setTextColor(100); pdf.setFontSize(8);
                        pdf.text('  Ref: ' + issue.ref, 25, y);
                        y += 4;
                        pdf.text('  √Ötg√§rd: ' + issue.action, 25, y);
                        y += 7;
                        pdf.setFontSize(10);
                    });
                }
            }

            pdf.setFontSize(8); pdf.setTextColor(150);
            pdf.text('Genererad: ' + new Date().toLocaleString('sv-SE'), 105, 287, { align: 'center' });
            pdf.save('hoppborg-inspektion-' + new Date().toISOString().split('T')[0] + '.pdf');
        }

        function render() {
            const c = calc();
            const d = app.data;
            
            let html = '<div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg shadow-lg p-6 mb-6">';
            html += '<div class="text-sm opacity-90">EN 14960-1:2019</div>';
            html += '<h1 class="text-3xl font-bold">Hoppborg Validator</h1>';
            html += '<p class="text-sm mt-1 opacity-90">Baserad p√• Konsumentverkets marknadskontroll</p></div>';

            html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6">';
            html += '<h2 class="text-xl font-bold mb-4">üìè Grunduppgifter</h2>';
            html += '<div class="grid grid-cols-3 gap-4 mb-6">';
            html += '<div><label class="block text-sm font-medium mb-1">L√§ngd (m) * <button onclick="showInfo(\'height\')" class="text-blue-600">‚ÑπÔ∏è</button></label>';
            html += '<input type="number" step="0.1" id="length" value="' + d.length + '" class="w-full p-2 border rounded"></div>';
            html += '<div><label class="block text-sm font-medium mb-1">Bredd (m) *</label>';
            html += '<input type="number" step="0.1" id="width" value="' + d.width + '" class="w-full p-2 border rounded"></div>';
            html += '<div><label class="block text-sm font-medium mb-1">H√∂jd (m) * <button onclick="showInfo(\'height\')" class="text-blue-600">‚ÑπÔ∏è</button></label>';
            html += '<input type="number" step="0.1" id="height" value="' + d.height + '" class="w-full p-2 border rounded">';
            html += '<p class="text-xs text-gray-500 mt-1">Mark ‚Üí v√§gg (EJ dekorationer!)</p></div></div></div>';

            html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6"><h2 class="text-xl font-bold mb-4">üè∞ Typ och konstruktion</h2><div class="grid grid-cols-2 gap-4 mb-4">';
            
            html += '<div><label class="block text-sm font-medium mb-1">Typ</label><select id="type" class="w-full p-2 border rounded"><option value="">-- V√§lj --</option>';
            const types = [['flatbed','Flat-bed (4 √∂ppna sidor)'],['castle','Castle (3 v√§ggar, 1 √∂ppen)'],['aframe','A-Frame inflatable'],['combo','Bounce/Slide kombination'],['multiplay','Multi-Play Center'],['obstacle','Hinderbana'],['slide','Inflatable slide'],['enclosed','Enclosed inflatable'],['softmountain','Soft mountain']];
            types.forEach(t => { html += '<option value="' + t[0] + '"' + (d.type === t[0] ? ' selected' : '') + '>' + t[1] + '</option>'; });
            html += '</select></div>';

            html += '<div><label class="block text-sm font-medium mb-1">Plattformsh√∂jd (m)</label><input type="number" step="0.1" id="platformHeight" value="' + d.platformHeight + '" class="w-full p-2 border rounded"><p class="text-xs text-gray-500 mt-1">Fr√•n mark till lekyta (4.2.3)</p></div>';
            html += '<div><label class="block text-sm font-medium mb-1">V√§ggh√∂jd (m)</label><input type="number" step="0.1" id="wallHeight" value="' + d.wallHeight + '" class="w-full p-2 border rounded"><p class="text-xs text-gray-500 mt-1">Fr√•n lekyta till v√§ggtop (4.2.9)</p></div>';
            html += '<div><label class="block text-sm font-medium mb-1">Har rutschbana?</label><select id="hasSlide" class="w-full p-2 border rounded"><option value="">-- V√§lj --</option><option value="yes"' + (d.hasSlide==='yes'?' selected':'') + '>Ja</option><option value="no"' + (d.hasSlide==='no'?' selected':'') + '>Nej</option></select></div>';
            html += '<div><label class="block text-sm font-medium mb-1">Finns rep?</label><select id="hasRopes" class="w-full p-2 border rounded"><option value="">-- V√§lj --</option><option value="no"' + (d.hasRopes==='no'?' selected':'') + '>Nej</option><option value="yes"' + (d.hasRopes==='yes'?' selected':'') + '>Ja</option></select></div>';
            html += '<div><label class="block text-sm font-medium mb-1">Har n√§t?</label><select id="hasNetting" class="w-full p-2 border rounded"><option value="">-- V√§lj --</option><option value="yes"' + (d.hasNetting==='yes'?' selected':'') + '>Ja</option><option value="no"' + (d.hasNetting==='no'?' selected':'') + '>Nej</option></select></div>';

            if (d.hasNetting === 'yes') {
                html += '<div><label class="block text-sm font-medium mb-1">Maskstorlek (mm)</label><input type="number" id="nettingMesh" value="' + d.nettingMesh + '" class="w-full p-2 border rounded" placeholder="Max 8"></div>';
                html += '<div><label class="block text-sm font-medium mb-1">N√•r h√∂rnen? <button onclick="showInfo(\'corners\')" class="text-blue-600">‚ÑπÔ∏è</button></label><select id="nettingCorners" class="w-full p-2 border rounded"><option value="">-- V√§lj --</option><option value="yes"' + (d.nettingCorners==='yes'?' selected':'') + '>Ja</option><option value="no"' + (d.nettingCorners==='no'?' selected':'') + '>Nej</option></select></div>';
            }
            html += '</div></div>';

            if (d.hasSlide === 'yes') {
                html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6 border-l-4 border-purple-500"><h2 class="text-xl font-bold mb-4">üõù Rutschbana <button onclick="showInfo(\'runout\')" class="text-blue-600">‚ÑπÔ∏è</button></h2><div class="grid grid-cols-2 gap-4">';
                html += '<div><label class="block text-sm font-medium mb-1">Slide plattformsh√∂jd (m)</label><input type="number" step="0.1" id="slideHeight" value="' + d.slideHeight + '" class="w-full p-2 border rounded"></div>';
                html += '<div><label class="block text-sm font-medium mb-1">Run-out l√§ngd (m)</label><input type="number" step="0.1" id="runoutLength" value="' + d.runoutLength + '" class="w-full p-2 border rounded"><p class="text-xs text-gray-500 mt-1">Min 50% av h√∂jd ELLER 0.3m</p></div>';
                html += '<div class="col-span-2"><label class="flex items-center gap-2"><input type="checkbox" id="hasStopWall"' + (d.hasStopWall?' checked':'') + ' class="w-4 h-4"><span class="text-sm font-medium">Har stoppv√§gg (+500mm)</span></label></div>';
                if (c && c.runoutRequired) html += '<div class="col-span-2 p-3 bg-blue-50 border-l-4 border-blue-500 rounded"><p class="text-sm font-semibold">üßÆ Ber√§knad run-out:</p><p class="text-sm">Krav: <strong>' + c.runoutRequired.toFixed(2) + ' m</strong></p></div>';
                html += '</div></div>';
            }

            html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6"><h2 class="text-xl font-bold mb-4">üö™ Ing√•ng/Trappa (4.2.3)</h2><div class="grid grid-cols-2 gap-4">';
            html += '<div><label class="block text-sm font-medium mb-1">Ing√•ngsh√∂jd (m)</label><input type="number" step="0.1" id="entranceHeight" value="' + d.entranceHeight + '" class="w-full p-2 border rounded"><p class="text-xs text-gray-500 mt-1">Max 0.63m</p></div>';
            html += '<div><label class="block text-sm font-medium mb-1">Trappdjup (m)</label><input type="number" step="0.1" id="entranceTreadDepth" value="' + d.entranceTreadDepth + '" class="w-full p-2 border rounded"><p class="text-xs text-gray-500 mt-1">Min 1.5√ó plattformsh√∂jd</p></div>';
            if (c && c.minTreadDepth > 0) html += '<div class="col-span-2 p-2 bg-blue-50 rounded text-sm">Ber√§knat minsta trappdjup: <strong>' + c.minTreadDepth.toFixed(2) + ' m</strong></div>';
            html += '</div></div>';

            html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6"><h2 class="text-xl font-bold mb-4">‚öì F√∂rankring <button onclick="showInfo(\'annexA\')" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded">üìê Annex A</button></h2>';
            
            if (c && c.L && c.W) {
                html += '<div class="mb-4 p-4 bg-blue-50 rounded"><div class="text-center font-semibold mb-2">√ñversikt f√§stpunkter</div>';
                html += '<svg viewBox="0 0 ' + (c.L * 40) + ' ' + (c.W * 40) + '" class="w-full max-w-md mx-auto border-2 border-blue-500 bg-white rounded">';
                html += '<rect x="0" y="0" width="' + (c.L * 40) + '" height="' + (c.W * 40) + '" fill="#eff6ff" stroke="#3b82f6" stroke-width="2"/>';
                html += '<text x="' + (c.L * 20) + '" y="20" text-anchor="middle" font-weight="bold" fill="#1e40af">Sida A</text>';
                html += '<text x="' + (c.L * 40 - 10) + '" y="' + (c.W * 20) + '" text-anchor="end" font-weight="bold" fill="#1e40af" transform="rotate(-90 ' + (c.L * 40 - 10) + ' ' + (c.W * 20) + ')">B</text>';
                html += '<text x="' + (c.L * 20) + '" y="' + (c.W * 40 - 5) + '" text-anchor="middle" font-weight="bold" fill="#1e40af">Sida C</text>';
                html += '<text x="10" y="' + (c.W * 20) + '" font-weight="bold" fill="#1e40af" transform="rotate(-90 10 ' + (c.W * 20) + ')">D</text>';
                html += '</svg></div>';
            }

            html += '<div class="grid grid-cols-2 gap-4 mb-4">';
            if (c) ['A','B','C','D'].forEach(s => { html += '<div><label class="block text-sm font-medium mb-1">Sida ' + s + ': F√§stpunkter <span class="text-xs text-gray-500">(Krav: ' + c.anchors[s].need + ' st)</span></label><input type="number" id="anchor' + s + '" value="' + d['anchor' + s] + '" class="w-full p-2 border rounded"></div>'; });
            html += '<div><label class="block text-sm font-medium mb-1">F√∂rankringsvinkel (¬∞)</label><input type="number" id="anchorAngle" value="' + d.anchorAngle + '" class="w-full p-2 border rounded" placeholder="30-45"></div></div>';

            html += '<button onclick="' + (app.cameraActive ? 'stopCamera()' : 'startCamera()') + '" class="w-full flex items-center justify-center gap-2 py-3 rounded-lg font-medium mb-4 ' + (app.cameraActive ? 'bg-red-600' : 'bg-green-600') + ' text-white">üì∑ ' + (app.cameraActive ? 'St√§ng kamera' : '√ñppna kamera f√∂r vinkelm√§tning') + '</button>';

            if (app.cameraActive) {
                html += '<div class="mb-6 relative bg-black rounded-lg overflow-hidden"><video id="cam" autoplay playsinline class="w-full"></video>';
                html += '<svg class="absolute inset-0 w-full h-full pointer-events-none" viewBox="0 0 100 100" preserveAspectRatio="none">';
                html += '<line x1="0" y1="80" x2="100" y2="80" stroke="#22c55e" stroke-width="0.5" stroke-dasharray="2,2"/>';
                html += '<line x1="50" y1="80" x2="85" y2="60" stroke="#fbbf24" stroke-width="0.8"/><text x="70" y="58" fill="#fbbf24" font-size="4" font-weight="bold">30¬∞</text>';
                html += '<line x1="50" y1="80" x2="80" y2="50" stroke="#ef4444" stroke-width="0.8"/><text x="65" y="48" fill="#ef4444" font-size="4" font-weight="bold">45¬∞</text>';
                html += '<path d="M 50 80 L 85 60 L 80 50 Z" fill="#22c55e" opacity="0.2"/><circle cx="50" cy="80" r="2" fill="#22c55e"/></svg></div>';
            }
            html += '</div>';

            html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6"><h2 class="text-xl font-bold mb-4">üí® Lufttryck & Fl√§ktar</h2><div class="grid grid-cols-2 gap-4">';
            html += '<div><label class="block text-sm font-medium mb-1">Antal fl√§ktar</label><input type="number" id="blowersNeeded" value="' + d.blowersNeeded + '" class="w-full p-2 border rounded">';
            if (c) html += '<p class="text-xs text-gray-500 mt-1">Ber√§knat: ' + c.blowersNeeded + ' st</p>';
            html += '</div><div><label class="block text-sm font-medium mb-1">Fl√§kteffekt (W)</label><input type="number" id="blowerPower" value="' + d.blowerPower + '" class="w-full p-2 border rounded" placeholder="1500"></div>';
            html += '<div><label class="block text-sm font-medium mb-1">Inbl√•sr√∂rets l√§ngd (m)</label><input type="number" step="0.1" id="blowerTubeLength" value="' + d.blowerTubeLength + '" class="w-full p-2 border rounded"><p class="text-xs text-gray-500 mt-1">Min 1.2m fr√•n v√§gg, 2.5m fr√•n √∂ppen (4.2.4)</p></div></div></div>';

            html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6"><h2 class="text-xl font-bold mb-4">üè∑Ô∏è M√§rkning & Tillverkarkrav</h2><div class="grid grid-cols-2 gap-4">';
            html += '<div><label class="block text-sm font-medium mb-1">Produkt-ID *</label><input type="text" id="productId" value="' + d.productId + '" class="w-full p-2 border rounded"></div>';
            html += '<div><label class="block text-sm font-medium mb-1">ID synligt?</label><select id="idVisible" class="w-full p-2 border rounded"><option value="">-- V√§lj --</option><option value="yes"' + (d.idVisible==='yes'?' selected':'') + '>Ja</option><option value="no"' + (d.idVisible==='no'?' selected':'') + '>Nej</option></select></div>';
            html += '<div><label class="block text-sm font-medium mb-1">Tillverkarens max anv√§ndare</label><input type="number" id="manufacturerMaxUsers" value="' + d.manufacturerMaxUsers + '" class="w-full p-2 border rounded"></div>';
            html += '<div><label class="block text-sm font-medium mb-1">Tillverkarens max anv√§ndarl√§ngd (m)</label><input type="number" step="0.1" id="manufacturerUserHeight" value="' + d.manufacturerUserHeight + '" class="w-full p-2 border rounded"></div>';
            html += '<div class="col-span-2"><label class="flex items-center gap-2"><input type="checkbox" id="hasSafetyInstructions"' + (d.hasSafetyInstructions?' checked':'') + ' class="w-4 h-4"><span class="text-sm font-medium">Finns s√§kerhetsinstruktion angiven</span></label></div></div></div>';

            html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6"><h2 class="text-xl font-bold mb-4">üì∏ Bilder fr√•n inspektion</h2>';
            html += '<label class="block w-full cursor-pointer bg-orange-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-orange-700 text-center mb-4">üì∏ L√§gg till bild<input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden"></label>';
            
            if (d.images.length > 0) {
                html += '<div class="grid grid-cols-2 gap-4">';
                d.images.forEach((img, i) => {
                    html += '<div class="relative border rounded-lg overflow-hidden"><img src="' + img.data + '" class="w-full h-32 object-cover">';
                    html += '<button onclick="removeImage(' + i + ')" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6">√ó</button>';
                    html += '<div class="p-2 bg-gray-50 text-xs truncate">' + img.name + '</div></div>';
                });
                html += '</div>';
            }
            html += '</div>';

            html += '<button onclick="validate()" class="w-full bg-blue-600 text-white py-4 rounded-lg text-lg font-bold hover:bg-blue-700 mb-6">‚úì VALIDERA HOPPBORG</button>';

            if (app.result) {
                html += '<div class="space-y-6"><div class="rounded-lg shadow-lg p-6 border-l-8 ' + (app.result.ok ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500') + '"><h3 class="text-2xl font-bold">' + (app.result.ok ? '‚úì GODK√ÑND' : '‚úó UNDERK√ÑND') + '</h3><p>' + app.result.issues.length + ' avvikelser totalt</p></div>';

                html += '<div class="bg-white rounded-lg shadow-lg p-6"><h3 class="text-xl font-bold mb-4">üìä Sammanfattning</h3><div class="grid grid-cols-4 gap-4 mb-6">';
                html += '<div class="bg-gray-50 p-4 rounded text-center"><div class="text-3xl font-bold text-gray-600">' + app.result.issues.length + '</div><div class="text-sm">Totalt</div></div>';
                html += '<div class="bg-red-50 p-4 rounded text-center"><div class="text-3xl font-bold text-red-600">' + app.result.critical.length + '</div><div class="text-sm">Kritiska</div></div>';
                html += '<div class="bg-orange-50 p-4 rounded text-center"><div class="text-3xl font-bold text-orange-600">' + app.result.serious.length + '</div><div class="text-sm">Allvarliga</div></div>';
                html += '<div class="bg-yellow-50 p-4 rounded text-center"><div class="text-3xl font-bold text-yellow-600">' + app.result.warnings.length + '</div><div class="text-sm">Varningar</div></div></div>';

                html += '<h4 class="font-bold mb-3">Krav vs Uppm√§tta v√§rden</h4><div class="overflow-x-auto mb-6"><table class="w-full text-sm border-collapse"><thead class="bg-gray-100"><tr><th class="p-2 text-left border">Parameter</th><th class="p-2 text-left border">Krav</th><th class="p-2 text-left border">Uppm√§tt</th><th class="p-2 text-center border">Status</th></tr></thead><tbody>';
                ['A','B','C','D'].forEach(s => {
                    const req = c.anchors[s].need;
                    const supplied = parseInt(d['anchor' + s]) || 0;
                    const ok = supplied >= req;
                    html += '<tr class="' + (ok ? '' : 'bg-red-50') + '"><td class="p-2 border">F√§stpunkter Sida ' + s + '</td><td class="p-2 border">' + req + ' st</td><td class="p-2 border">' + supplied + ' st</td><td class="p-2 text-center border"><span class="' + (ok ? 'text-green-600' : 'text-red-600') + '">' + (ok ? '‚úì' : '‚úó') + '</span></td></tr>';
                });
                html += '</tbody></table></div>';

                ['critical','serious','warnings'].forEach(severity => {
                    const items = app.result[severity];
                    if (items.length > 0) {
                        const labels = { critical: 'Kritiska fel', serious: 'Allvarliga fel', warnings: 'Varningar' };
                        const colors = { critical: 'red', serious: 'orange', warnings: 'yellow' };
                        const color = colors[severity];
                        html += '<h4 class="font-bold text-' + color + '-900 mb-3">' + labels[severity] + '</h4><div class="space-y-3 mb-6">';
                        items.forEach(i => {
                            html += '<div class="border-l-4 border-' + color + '-500 bg-' + color + '-50 p-4 rounded"><div class="font-semibold">' + i.cat + '</div><div class="text-sm">' + i.msg + '</div><div class="text-xs text-gray-600 mt-1">Ref: ' + i.ref + '</div><div class="text-xs text-' + color + '-800 mt-2"><strong>√Ötg√§rd:</strong> ' + i.action + '</div></div>';
                        });
                        html += '</div>';
                    }
                });

                html += '</div><div class="flex gap-3"><button onclick="exportPDF()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700">üìÑ Spara som PDF</button><button onclick="app.result=null; render()" class="flex-1 bg-gray-600 text-white py-3 rounded-lg font-medium hover:bg-gray-700">üîÑ Ny validering</button></div></div>';
            }

            document.getElementById('app').innerHTML = html;

            ['length','width','height','type','platformHeight','wallHeight','hasSlide','slideHeight','runoutLength','entranceHeight','entranceTreadDepth','blowerTubeLength','anchorA','anchorB','anchorC','anchorD','anchorAngle','blowersNeeded','blowerPower','productId','idVisible','manufacturerMaxUsers','manufacturerUserHeight','hasRopes','hasNetting','nettingMesh','nettingCorners'].forEach(f => {
                const el = document.getElementById(f);
                if (el) el.addEventListener('change', e => { app.data[f] = e.target.value; render(); });
            });

            ['hasSafetyInstructions','hasStopWall'].forEach(f => {
                const el = document.getElementById(f);
                if (el) el.addEventListener('change', e => { app.data[f] = e.target.checked; render(); });
            });

            const imgInput = document.getElementById('imageInput');
            if (imgInput) imgInput.addEventListener('change', (e) => { if (e.target.files[0]) addImage(e.target.files[0]); });
        }

        const saved = localStorage.getItem('hoppborg');
        if (saved) { try { const parsed = JSON.parse(saved); app.data = parsed.data || app.data; } catch (e) {} }
        render();
    </script>
</body>
</html>
