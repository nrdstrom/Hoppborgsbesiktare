<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoppborg Validator - EN 14960-1:2019</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="max-w-4xl mx-auto p-4"></div>
    
    <div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="closeModal()">
        <div class="bg-white rounded-lg p-6 max-w-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <button onclick="closeModal()" class="float-right text-3xl text-gray-500 hover:text-gray-700">&times;</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        const app = {
            lang: 'sv',
            data: {
                length: '', width: '', height: '', type: '',
                heightA: '', heightB: '', heightC: '', heightD: '',
                useIndividualHeights: false,
                platformHeight: '', wallHeight: '',
                hasSlide: '', slideHeight: '', runoutLength: '', hasStopWall: false,
                entranceHeight: '', entranceTreadDepth: '',
                anchorA: '', anchorB: '', anchorC: '', anchorD: '', anchorAngle: '',
                blowersNeeded: '', blowerPower: '', blowerTubeLength: '',
                productId: '', idVisible: '', hasSafetyInstructions: false,
                manufacturerMaxUsers: '', manufacturerUserHeight: '',
                hasRopes: '', hasNetting: '', nettingMesh: '', nettingCorners: '',
                surfaceType: '', impactAreaWidth: '',
                images: []
            },
            result: null,
            cameraActive: false,
            stream: null
        };

        // KOMPLETT √∂vers√§ttningsobjekt
        const t = {
            sv: {
                // Header
                title: 'Hoppborg Validator',
                subtitle: 'Baserad p√• Konsumentverkets marknadskontroll',
                langToggle: 'English',
                
                // Knappar
                validate: '‚úì VALIDERA HOPPBORG',
                approved: '‚úì GODK√ÑND',
                failed: '‚úó UNDERK√ÑND',
                addImage: 'üì∏ L√§gg till bild',
                openCamera: 'üì∑ √ñppna kamera f√∂r vinkelm√§tning',
                closeCamera: 'üì∑ St√§ng kamera',
                savePdf: 'üìÑ Spara som PDF',
                newValidation: 'üîÑ Ny validering',
                
                // Sektioner
                basicInfo: 'Grunduppgifter',
                typeConstruction: 'Typ och konstruktion',
                slide: 'Rutschbana-specifika krav',
                entrance: 'Ing√•ng/Trappa',
                entranceRef: 'Ing√•ng/Trappa (4.2.3)',
                anchoring: 'F√∂rankring',
                airPressure: 'Lufttryck & Fl√§ktar',
                marking: 'M√§rkning & Tillverkarkrav',
                images: 'Bilder fr√•n inspektion',
                
                // Grunduppgifter
                length: 'L√§ngd (m)',
                width: 'Bredd (m)',
                height: 'H√∂jd (m)',
                edgeToEdgeLength: 'Kant till kant i l√§ngdriktning',
                edgeToEdgeWidth: 'Kant till kant i tv√§rriktning',
                groundToWall: 'Mark ‚Üí v√§gg (EJ dekorationer!)',
                
                // Individuella h√∂jder
                individualHeightsLabel: 'Olika h√∂jder per sida (f√∂r exakt Annex A-ber√§kning)',
                individualHeightsHelp: 'Aktivera detta om sidorna har olika h√∂jder (t.ex. √∂ppen ing√•ng fram, h√∂gre baksida). Annars anv√§nds den generella h√∂jden ovan f√∂r alla sidor.',
                heightSideA: 'H√∂jd Sida A (Fram)',
                heightSideB: 'H√∂jd Sida B (H√∂ger)',
                heightSideC: 'H√∂jd Sida C (Bak)',
                heightSideD: 'H√∂jd Sida D (V√§nster)',
                
                // Typ & konstruktion
                type: 'Typ',
                selectType: '-- V√§lj typ --',
                typeFlatbed: 'Flat-bed (4 √∂ppna sidor)',
                typeCastle: 'Castle (3 v√§ggar, 1 √∂ppen)',
                typeAframe: 'A-Frame inflatable',
                typeCombo: 'Bounce/Slide kombination',
                typeMultiplay: 'Multi-Play Center',
                typeObstacle: 'Hinderbana',
                typeSlide: 'Inflatable slide',
                typeEnclosed: 'Enclosed inflatable',
                typeSoftmountain: 'Soft mountain',
                platformHeight: 'Plattformsh√∂jd (m)',
                platformHeightHelp: 'Fr√•n mark till lekyta (4.2.3)',
                wallHeight: 'V√§ggh√∂jd (m)',
                wallHeightHelp: 'Fr√•n lekyta till v√§ggtop (4.2.9)',
                hasSlide: 'Har rutschbana?',
                hasRopes: 'Finns rep?',
                hasNetting: 'Har n√§t?',
                meshSize: 'Maskstorlek (mm)',
                reachesCorners: 'N√•r h√∂rnen?',
                selectOption: '-- V√§lj --',
                yes: 'Ja',
                no: 'Nej',
                meshPlaceholder: 'Max 8',
                
                // Slide
                slideHeight: 'Slide plattformsh√∂jd (m)',
                runoutLength: 'Run-out l√§ngd (m)',
                minRunout: 'Min 50% av h√∂jd ELLER 0.3m',
                hasStopWall: 'Har stoppv√§gg (+500mm till√§gg)',
                calculatedRunout: 'Ber√§knad run-out:',
                requirement: 'Krav:',
                
                // Trappa
                entranceHeight: 'Ing√•ngsh√∂jd (m)',
                entranceHeightHelp: 'Max 0.63m (loaded), 0.6m (unloaded)',
                treadDepth: 'Trappdjup (m)',
                minTreadDepth: 'Min 1.5√ó plattformsh√∂jd',
                calculatedFromPlatform: 'Ber√§knat fr√•n plattformsh√∂jd',
                minimumTreadDepth: 'Minsta trappdjup:',
                
                // F√∂rankring
                anchoringTitle: 'F√∂rankring',
                annexAExplanation: 'üìê Annex A F√∂rklaring',
                anchorPointsOverview: '√ñversikt f√§stpunkter',
                sideLabel: 'Sida',
                sideLabelShort: 'Sida',
                anchorPoints: 'F√§stpunkter',
                requirementShort: 'Krav:',
                stShort: 'st',
                atHeight: '@ ',
                heightShort: 'm h√∂jd',
                heightLabel: 'H√∂jd:',
                areaLabel: 'yta',
                anchorAngle: 'F√∂rankringsvinkel (¬∞)',
                anchorAnglePlaceholder: '30-45',
                
                // Lufttryck
                blowersCount: 'Antal fl√§ktar',
                calculated: 'Ber√§knat:',
                blowerPower: 'Fl√§kteffekt (W)',
                powerPlaceholder: '1500',
                blowerTubeLength: 'Inbl√•sr√∂rets l√§ngd (m)',
                tubeLengthWarning: '‚ö†Ô∏è Minimum 1.2m fr√•n v√§gg, 2.5m fr√•n √∂ppen sida',
                tubeLengthRecommended: '‚úì Rekommenderat: 1.4m eller l√§ngre',
                
                // M√§rkning
                productId: 'Produkt-ID',
                idVisible: 'ID synligt?',
                maxUsers: 'Tillverkarens max anv√§ndare',
                maxUserHeight: 'Tillverkarens max anv√§ndarl√§ngd (m)',
                hasSafetyInst: 'Finns s√§kerhetsinstruktion angiven',
                
                // Resultat
                totalIssues: 'avvikelser totalt',
                summary: 'Sammanfattning',
                total: 'Totalt',
                critical: 'Kritiska',
                serious: 'Allvarliga',
                warnings: 'Varningar',
                reqVsMeasured: 'Krav vs Uppm√§tta v√§rden',
                parameter: 'Parameter',
                required: 'Krav',
                measured: 'Uppm√§tt',
                status: 'Status',
                anchorSide: 'F√§stpunkter Sida',
                criticalIssues: 'Kritiska fel',
                seriousIssues: 'Allvarliga fel',
                warningIssues: 'Varningar',
                category: 'Kategori',
                reference: 'Ref:',
                action: '√Ötg√§rd:',
                
                // Modals
                howToMeasureLength: 'Hur m√§ter man l√§ngd?',
                howToMeasureWidth: 'Hur m√§ter man bredd?',
                howToMeasureHeight: 'Hur m√§ter man h√∂jd?',
                
                // Valideringsmeddelanden
                fillBasicInfo: 'Fyll i l√§ngd, bredd och h√∂jd f√∂rst',
                ropesForbidden: 'REP F√ñRBJUDET! Risk f√∂r strypning',
                removeRopesImmediately: 'Ta bort alla rep omedelbart',
                productIdMissing: 'Produkt-ID saknas',
                markWithId: 'M√§rk borgen med unikt ID',
                idNotVisible: 'ID ej synligt under anv√§ndning',
                moveIdMarking: 'Flytta ID-m√§rkning s√• den syns',
                insufficientAnchors: ' st < ',
                requiredAnchors: ' st kr√§vs',
                addAnchorPoints: 'L√§gg till',
                anchorPointsText: 'f√§stpunkter',
                incorrectAngle: 'Vinkel ',
                shouldBe30to45: '¬∞ (ska vara 30-45¬∞)',
                adjustAngle: 'Justera f√∂rankringsvinkeln',
                runoutTooShort: ' m < ',
                lessThanRequired: ' m kr√§vs',
                extendRunout: 'F√∂rl√§ng run-out med ',
                blowerTubeTooShort: 'Inbl√•sr√∂r ',
                lessThan12m: 'm < 1.2m MINIMUM',
                replaceTube: 'Byt till l√§ngre r√∂r (minst 1.4m rekommenderas starkt)',
                blowerTubeWarning: 'm < 1.4m (rekommenderat)',
                replaceForOptimal: 'Byt till 1.4m r√∂r f√∂r optimal s√§kerhet',
                treadDepthInsufficient: 'Trappdjup ',
                timesPlatformHeight: 'm (1.5√ó plattformsh√∂jd)',
                extendTreadDepth: 'F√∂rl√§ng trappdjupet',
                safetyInstructionsMissing: 'S√§kerhetsinstruktion saknas',
                attachInstructions: 'F√§st tydliga s√§kerhetsinstruktioner',
                meshTooLarge: 'Maskstorlek ',
                greaterThan8mm: 'mm > 8mm',
                replaceWithSmallerMesh: 'Byt till n√§t med mindre maskor',
                nettingNoCorners: 'N√§ten n√•r inte h√∂rnen',
                installCornerNetting: 'Montera n√§t som n√•r alla h√∂rn',
                insufficientBlowers: ' fl√§ktar < ',
                blowersRequired: ' kr√§vs f√∂r denna volym',
                addBlowers: 'L√§gg till ',
                blowersText: ' fl√§ktar',
                missing: 'Saknas',
                generated: 'Genererad'
            },
            en: {
                // Header
                title: 'Bouncy Castle Validator',
                subtitle: 'Based on Swedish Consumer Agency market surveillance',
                langToggle: 'Svenska',
                
                // Buttons
                validate: '‚úì VALIDATE BOUNCY CASTLE',
                approved: '‚úì APPROVED',
                failed: '‚úó FAILED',
                addImage: 'üì∏ Add image',
                openCamera: 'üì∑ Open camera for angle measurement',
                closeCamera: 'üì∑ Close camera',
                savePdf: 'üìÑ Save as PDF',
                newValidation: 'üîÑ New validation',
                
                // Sections
                basicInfo: 'Basic Information',
                typeConstruction: 'Type and Construction',
                slide: 'Slide-Specific Requirements',
                entrance: 'Entrance/Stairs',
                entranceRef: 'Entrance/Stairs (4.2.3)',
                anchoring: 'Anchoring',
                airPressure: 'Air Pressure & Blowers',
                marking: 'Marking & Manufacturer Requirements',
                images: 'Inspection Images',
                
                // Basic info
                length: 'Length (m)',
                width: 'Width (m)',
                height: 'Height (m)',
                edgeToEdgeLength: 'Edge to edge lengthwise',
                edgeToEdgeWidth: 'Edge to edge crosswise',
                groundToWall: 'Ground ‚Üí wall (NO decorations!)',
                
                // Individual heights
                individualHeightsLabel: 'Different heights per side (for exact Annex A calculation)',
                individualHeightsHelp: 'Enable this if sides have different heights (e.g., open entrance front, higher back side). Otherwise, the general height above is used for all sides.',
                heightSideA: 'Height Side A (Front)',
                heightSideB: 'Height Side B (Right)',
                heightSideC: 'Height Side C (Back)',
                heightSideD: 'Height Side D (Left)',
                
                // Type & construction
                type: 'Type',
                selectType: '-- Select type --',
                typeFlatbed: 'Flat-bed (4 open sides)',
                typeCastle: 'Castle (3 walls, 1 open)',
                typeAframe: 'A-Frame inflatable',
                typeCombo: 'Bounce/Slide combination',
                typeMultiplay: 'Multi-Play Center',
                typeObstacle: 'Obstacle course',
                typeSlide: 'Inflatable slide',
                typeEnclosed: 'Enclosed inflatable',
                typeSoftmountain: 'Soft mountain',
                platformHeight: 'Platform Height (m)',
                platformHeightHelp: 'From ground to play surface (4.2.3)',
                wallHeight: 'Wall Height (m)',
                wallHeightHelp: 'From play surface to wall top (4.2.9)',
                hasSlide: 'Has slide?',
                hasRopes: 'Has ropes?',
                hasNetting: 'Has netting?',
                meshSize: 'Mesh Size (mm)',
                reachesCorners: 'Reaches corners?',
                selectOption: '-- Select --',
                yes: 'Yes',
                no: 'No',
                meshPlaceholder: 'Max 8',
                
                // Slide
                slideHeight: 'Slide platform height (m)',
                runoutLength: 'Run-out length (m)',
                minRunout: 'Min 50% of height OR 0.3m',
                hasStopWall: 'Has stop wall (+500mm addition)',
                calculatedRunout: 'Calculated run-out:',
                requirement: 'Requirement:',
                
                // Entrance
                entranceHeight: 'Entrance height (m)',
                entranceHeightHelp: 'Max 0.63m (loaded), 0.6m (unloaded)',
                treadDepth: 'Tread depth (m)',
                minTreadDepth: 'Min 1.5√ó platform height',
                calculatedFromPlatform: 'Calculated from platform height',
                minimumTreadDepth: 'Minimum tread depth:',
                
                // Anchoring
                anchoringTitle: 'Anchoring',
                annexAExplanation: 'üìê Annex A Explanation',
                anchorPointsOverview: 'Anchor Points Overview',
                sideLabel: 'Side',
                sideLabelShort: 'Side',
                anchorPoints: 'Anchor Points',
                requirementShort: 'Req:',
                stShort: 'pcs',
                atHeight: '@ ',
                heightShort: 'm height',
                heightLabel: 'Height:',
                areaLabel: 'area',
                anchorAngle: 'Anchor angle (¬∞)',
                anchorAnglePlaceholder: '30-45',
                
                // Air pressure
                blowersCount: 'Number of blowers',
                calculated: 'Calculated:',
                blowerPower: 'Blower power (W)',
                powerPlaceholder: '1500',
                blowerTubeLength: 'Blower tube length (m)',
                tubeLengthWarning: '‚ö†Ô∏è Minimum 1.2m from wall, 2.5m from open side',
                tubeLengthRecommended: '‚úì Recommended: 1.4m or longer',
                
                // Marking
                productId: 'Product ID',
                idVisible: 'ID visible?',
                maxUsers: 'Manufacturer max users',
                maxUserHeight: 'Manufacturer max user height (m)',
                hasSafetyInst: 'Has safety instructions',
                
                // Results
                totalIssues: 'issues total',
                summary: 'Summary',
                total: 'Total',
                critical: 'Critical',
                serious: 'Serious',
                warnings: 'Warnings',
                reqVsMeasured: 'Required vs Measured Values',
                parameter: 'Parameter',
                required: 'Required',
                measured: 'Measured',
                status: 'Status',
                anchorSide: 'Anchor Points Side',
                criticalIssues: 'Critical Issues',
                seriousIssues: 'Serious Issues',
                warningIssues: 'Warnings',
                category: 'Category',
                reference: 'Ref:',
                action: 'Action:',
                
                // Modals
                howToMeasureLength: 'How to measure length?',
                howToMeasureWidth: 'How to measure width?',
                howToMeasureHeight: 'How to measure height?',
                
                // Validation messages
                fillBasicInfo: 'Fill in length, width and height first',
                ropesForbidden: 'ROPES FORBIDDEN! Strangulation risk',
                removeRopesImmediately: 'Remove all ropes immediately',
                productIdMissing: 'Product ID missing',
                markWithId: 'Mark castle with unique ID',
                idNotVisible: 'ID not visible during use',
                moveIdMarking: 'Move ID marking so it\'s visible',
                insufficientAnchors: ' pcs < ',
                requiredAnchors: ' pcs required',
                addAnchorPoints: 'Add ',
                anchorPointsText: ' anchor points',
                incorrectAngle: 'Angle ',
                shouldBe30to45: '¬∞ (should be 30-45¬∞)',
                adjustAngle: 'Adjust anchoring angle',
                runoutTooShort: ' m < ',
                lessThanRequired: ' m required',
                extendRunout: 'Extend run-out by ',
                blowerTubeTooShort: 'Blower tube ',
                lessThan12m: 'm < 1.2m MINIMUM',
                replaceTube: 'Replace with longer tube (at least 1.4m strongly recommended)',
                blowerTubeWarning: 'm < 1.4m (recommended)',
                replaceForOptimal: 'Replace with 1.4m tube for optimal safety',
                treadDepthInsufficient: 'Tread depth ',
                timesPlatformHeight: 'm (1.5√ó platform height)',
                extendTreadDepth: 'Extend tread depth',
                safetyInstructionsMissing: 'Safety instructions missing',
                attachInstructions: 'Attach clear safety instructions',
                meshTooLarge: 'Mesh size ',
                greaterThan8mm: 'mm > 8mm',
                replaceWithSmallerMesh: 'Replace with smaller mesh netting',
                nettingNoCorners: 'Netting doesn\'t reach corners',
                installCornerNetting: 'Install netting that reaches all corners',
                insufficientBlowers: ' blowers < ',
                blowersRequired: ' required for this volume',
                addBlowers: 'Add ',
                blowersText: ' blowers',
                missing: 'Missing',
                generated: 'Generated'
            }
        };

        function tr(key) {
            return t[app.lang][key] || key;
        }

        function toggleLang() {
            app.lang = app.lang === 'sv' ? 'en' : 'sv';
            render();
        }

        // Ber√§kningsfunktioner
        function calc() {
            const L = parseFloat(app.data.length) || 0;
            const W = parseFloat(app.data.width) || 0;
            const H = parseFloat(app.data.height) || 0;
            if (!L || !W || !H) return null;

            const calcSide = (len, height) => {
                const area = len * height;
                const F = 0.5 * 1.5 * 1.24 * 11.1 * 11.1 * area;
                const n = F / 1600;
                return Math.max(Math.ceil(n), 2);
            };

            const hA = app.data.useIndividualHeights ? (parseFloat(app.data.heightA) || H) : H;
            const hB = app.data.useIndividualHeights ? (parseFloat(app.data.heightB) || H) : H;
            const hC = app.data.useIndividualHeights ? (parseFloat(app.data.heightC) || H) : H;
            const hD = app.data.useIndividualHeights ? (parseFloat(app.data.heightD) || H) : H;

            const anchors = {
                A: { name: tr('sideLabelShort') + ' A', len: L, height: hA, need: calcSide(L, hA) },
                B: { name: tr('sideLabelShort') + ' B', len: W, height: hB, need: calcSide(W, hB) },
                C: { name: tr('sideLabelShort') + ' C', len: L, height: hC, need: calcSide(L, hC) },
                D: { name: tr('sideLabelShort') + ' D', len: W, height: hD, need: calcSide(W, hD) }
            };

            const totalAnchors = Object.values(anchors).reduce((s, a) => s + a.need, 0);
            const minAnchors = Math.max(6, totalAnchors);
            
            const volume = L * W * H;
            const blowersNeeded = Math.ceil(volume / 100);

            const slideH = parseFloat(app.data.slideHeight) || 0;
            const minRunout = Math.max(slideH * 0.5, 0.3);
            const runoutRequired = minRunout + (app.data.hasStopWall ? 0.5 : 0);

            const platformH = parseFloat(app.data.platformHeight) || 0;
            const minTreadDepth = platformH * 1.5;

            return { 
                anchors, minAnchors, L, W, H, blowersNeeded,
                runoutRequired, minRunout, minTreadDepth
            };
        }

        function validate() {
            const c = calc();
            if (!c) {
                alert(tr('fillBasicInfo'));
                return;
            }

            const issues = [];
            
            // KRITISKA FEL
            if (app.data.hasRopes === 'yes') {
                issues.push({ 
                    severity: 'critical',
                    cat: tr('typeConstruction'), 
                    msg: tr('ropesForbidden'), 
                    ref: '4.1.4',
                    action: tr('removeRopesImmediately')
                });
            }

            if (!app.data.productId) {
                issues.push({ 
                    severity: 'critical',
                    cat: tr('marking'), 
                    msg: tr('productIdMissing'), 
                    ref: '8',
                    action: tr('markWithId')
                });
            }

            if (app.data.idVisible === 'no') {
                issues.push({ 
                    severity: 'critical',
                    cat: tr('marking'), 
                    msg: tr('idNotVisible'), 
                    ref: '8',
                    action: tr('moveIdMarking')
                });
            }

            // F√∂rankring
            ['A', 'B', 'C', 'D'].forEach(side => {
                const supplied = parseInt(app.data['anchor' + side]) || 0;
                const req = c.anchors[side].need;
                if (supplied > 0 && supplied < req) {
                    issues.push({ 
                        severity: 'critical',
                        cat: tr('anchoring') + ' / ' + tr('sideLabelShort') + ' ' + side, 
                        msg: `${supplied}${tr('insufficientAnchors')}${req}${tr('requiredAnchors')}`, 
                        ref: 'Annex A',
                        action: `${tr('addAnchorPoints')} ${req - supplied} ${tr('anchorPointsText')}`
                    });
                }
            });

            // ALLVARLIGA FEL
            const angle = parseInt(app.data.anchorAngle) || 0;
            if (angle > 0 && (angle < 30 || angle > 45)) {
                issues.push({ 
                    severity: 'serious',
                    cat: tr('anchoring'), 
                    msg: `${tr('incorrectAngle')}${angle}${tr('shouldBe30to45')}`, 
                    ref: '4.2.1',
                    action: tr('adjustAngle')
                });
            }

            if (app.data.hasSlide === 'yes') {
                const runoutActual = parseFloat(app.data.runoutLength) || 0;
                if (runoutActual > 0 && runoutActual < c.runoutRequired) {
                    issues.push({ 
                        severity: 'critical',
                        cat: tr('slide') + ' / Run-out', 
                        msg: `${runoutActual}${tr('runoutTooShort')}${c.runoutRequired.toFixed(2)}${tr('lessThanRequired')}`, 
                        ref: '4.2.11',
                        action: `${tr('extendRunout')}${(c.runoutRequired - runoutActual).toFixed(2)}m`
                    });
                }
            }

            const tubeLen = parseFloat(app.data.blowerTubeLength) || 0;
            if (tubeLen > 0 && tubeLen < 1.2) {
                issues.push({ 
                    severity: 'critical',
                    cat: tr('airPressure'), 
                    msg: `${tr('blowerTubeTooShort')}${tubeLen}${tr('lessThan12m')}`, 
                    ref: '4.2.4',
                    action: tr('replaceTube')
                });
            } else if (tubeLen > 0 && tubeLen < 1.4) {
                issues.push({ 
                    severity: 'warning',
                    cat: tr('airPressure'), 
                    msg: `${tr('blowerTubeTooShort')}${tubeLen}${tr('blowerTubeWarning')}`, 
                    ref: '4.2.4',
                    action: tr('replaceForOptimal')
                });
            }

            const treadDepth = parseFloat(app.data.entranceTreadDepth) || 0;
            if (treadDepth > 0 && c.minTreadDepth > 0 && treadDepth < c.minTreadDepth) {
                issues.push({ 
                    severity: 'serious',
                    cat: tr('entrance'), 
                    msg: `${tr('treadDepthInsufficient')}${treadDepth}${tr('runoutTooShort')}${c.minTreadDepth.toFixed(2)}${tr('timesPlatformHeight')}`, 
                    ref: '4.2.3',
                    action: tr('extendTreadDepth')
                });
            }

            // VARNINGAR
            if (!app.data.hasSafetyInstructions) {
                issues.push({ 
                    severity: 'warning',
                    cat: tr('marking'), 
                    msg: tr('safetyInstructionsMissing'), 
                    ref: '6',
                    action: tr('attachInstructions')
                });
            }

            if (app.data.hasNetting === 'yes') {
                const mesh = parseFloat(app.data.nettingMesh) || 0;
                if (mesh > 8) {
                    issues.push({ 
                        severity: 'serious',
                        cat: tr('typeConstruction'), 
                        msg: `${tr('meshTooLarge')}${mesh}${tr('greaterThan8mm')}`, 
                        ref: '4.1.3',
                        action: tr('replaceWithSmallerMesh')
                    });
                }
                if (app.data.nettingCorners === 'no') {
                    issues.push({ 
                        severity: 'serious',
                        cat: tr('typeConstruction'), 
                        msg: tr('nettingNoCorners'), 
                        ref: '4.2.9',
                        action: tr('installCornerNetting')
                    });
                }
            }

            const blowers = parseInt(app.data.blowersNeeded) || 0;
            if (blowers > 0 && blowers < c.blowersNeeded) {
                issues.push({ 
                    severity: 'serious',
                    cat: tr('airPressure'), 
                    msg: `${blowers}${tr('insufficientBlowers')}${c.blowersNeeded}${tr('blowersRequired')}`, 
                    ref: '4.2.2',
                    action: `${tr('addBlowers')}${c.blowersNeeded - blowers}${tr('blowersText')}`
                });
            }

            const critical = issues.filter(i => i.severity === 'critical');
            const serious = issues.filter(i => i.severity === 'serious');
            const warnings = issues.filter(i => i.severity === 'warning');

            app.result = { 
                calc: c, 
                issues, 
                critical,
                serious,
                warnings,
                ok: critical.length === 0 && serious.length === 0
            };
            
            localStorage.setItem('hoppborg', JSON.stringify(app));
            render();
        }

        // Modal functions (kompakta f√∂r att spara plats)
        function showInfo(type) {
            const m = document.getElementById('modalContent');
            const modals = {
                length: `<h3 class="font-bold text-lg mb-3">üìè ${tr('howToMeasureLength')}</h3>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <p class="font-semibold mb-2">${app.lang === 'sv' ? '‚ö†Ô∏è VIKTIGT: L√§ngd = horisontellt m√•tt' : '‚ö†Ô∏è IMPORTANT: Length = horizontal measurement'}</p>
                        <p class="text-sm">${app.lang === 'sv' ? 'M√§t fr√•n kant till kant i l√§ngdriktningen p√• marken n√§r hoppborgen √§r uppbl√•st.' : 'Measure from edge to edge along the length on the ground when inflated.'}</p>
                    </div>
                    <svg viewBox="0 0 300 150" class="w-full max-w-md border-2 rounded bg-white mb-3 mx-auto">
                        <rect x="50" y="30" width="200" height="90" fill="#e3f2fd" stroke="#2196f3" stroke-width="2"/>
                        <line x1="50" y1="15" x2="250" y2="15" stroke="#f44336" stroke-width="3"/>
                        <line x1="50" y1="10" x2="50" y2="20" stroke="#f44336" stroke-width="2"/>
                        <line x1="250" y1="10" x2="250" y2="20" stroke="#f44336" stroke-width="2"/>
                        <text x="150" y="12" text-anchor="middle" font-size="12" fill="#f44336" font-weight="bold">${app.lang === 'sv' ? 'L√ÑNGD' : 'LENGTH'}</text>
                        <circle cx="50" cy="30" r="4" fill="#4caf50"/><circle cx="250" cy="30" r="4" fill="#4caf50"/>
                        <circle cx="50" cy="120" r="4" fill="#4caf50"/><circle cx="250" cy="120" r="4" fill="#4caf50"/>
                        <text x="150" y="80" text-anchor="middle" font-size="14" font-weight="bold">${app.lang === 'sv' ? 'HOPPBORG' : 'BOUNCY CASTLE'}</text>
                    </svg>
                    <div class="space-y-2 text-sm">
                        <p class="bg-green-50 p-2 rounded border-l-4 border-green-500"><strong class="text-green-700">‚úì ${app.lang === 'sv' ? 'R√§tt' : 'Correct'}:</strong> ${app.lang === 'sv' ? 'M√§t p√• markniv√• mellan ytterkanterna' : 'Measure at ground level between outer edges'}</p>
                        <p class="bg-red-50 p-2 rounded border-l-4 border-red-500"><strong class="text-red-700">‚úó ${app.lang === 'sv' ? 'Fel' : 'Wrong'}:</strong> ${app.lang === 'sv' ? 'M√§t inte diagonalt eller i luften' : 'Do not measure diagonally or in the air'}</p>
                    </div>`,
                width: `<h3 class="font-bold text-lg mb-3">üìè ${tr('howToMeasureWidth')}</h3>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <p class="font-semibold mb-2">${app.lang === 'sv' ? '‚ö†Ô∏è VIKTIGT: Bredd = horisontellt m√•tt tv√§rs √∂ver' : '‚ö†Ô∏è IMPORTANT: Width = horizontal measurement across'}</p>
                    </div>
                    <svg viewBox="0 0 300 150" class="w-full max-w-md border-2 rounded bg-white mb-3 mx-auto">
                        <rect x="50" y="30" width="200" height="90" fill="#e3f2fd" stroke="#2196f3" stroke-width="2"/>
                        <line x1="265" y1="30" x2="265" y2="120" stroke="#ff9800" stroke-width="3"/>
                        <text x="150" y="80" text-anchor="middle" font-size="14" font-weight="bold">${app.lang === 'sv' ? 'HOPPBORG' : 'BOUNCY CASTLE'}</text>
                    </svg>`,
                height: `<h3 class="font-bold text-lg mb-3">üìè ${tr('howToMeasureHeight')}</h3>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <p class="font-semibold mb-2">${app.lang === 'sv' ? '‚ö†Ô∏è VIKTIGT: H√∂jd = v√§ggarnas h√∂jd' : '‚ö†Ô∏è IMPORTANT: Height = wall height'}</p>
                        <p class="text-sm">${app.lang === 'sv' ? 'M√§t fr√•n marken till d√§r v√§ggarna slutar - INTE till dekorationer p√• taket!' : 'Measure from ground to where walls end - NOT to roof decorations!'}</p>
                    </div>`,
                annexA: `<h3 class="font-bold text-xl mb-3">${app.lang === 'sv' ? 'üìê Annex A: Ber√§kning av f√§stpunkter' : 'üìê Annex A: Anchor Point Calculation'}</h3>
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-4">
                        <p class="text-sm">${app.lang === 'sv' ? 'Dessa ber√§kningar s√§kerst√§ller att hoppborgen inte bl√•ser iv√§g i stark vind.' : 'These calculations ensure the bouncy castle won\'t blow away in strong wind.'}</p>
                    </div>`,
                corners: `<h3 class="font-bold mb-3">${app.lang === 'sv' ? 'üï∏Ô∏è N√§t m√•ste vara sydda l√§ngst ut i h√∂rnen' : 'üï∏Ô∏è Nets must be sewn to corners'}</h3>`
            };
            m.innerHTML = modals[type] || '';
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        async function startCamera() {
            try {
                app.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                app.cameraActive = true;
                render();
                setTimeout(() => { const v = document.getElementById('cam'); if (v) v.srcObject = app.stream; }, 100);
            } catch (e) { alert('Kamera: ' + e.message); }
        }

        function stopCamera() {
            if (app.stream) { app.stream.getTracks().forEach(t => t.stop()); app.stream = null; }
            app.cameraActive = false;
            render();
        }

        function addImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                app.data.images.push({ data: e.target.result, name: file.name, date: new Date().toISOString() });
                localStorage.setItem('hoppborg', JSON.stringify(app));
                render();
            };
            reader.readAsDataURL(file);
        }

        function removeImage(index) {
            app.data.images.splice(index, 1);
            localStorage.setItem('hoppborg', JSON.stringify(app));
            render();
        }

        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            let y = 20;
            pdf.setFontSize(20);
            pdf.setTextColor(37, 99, 235);
            pdf.text(tr('title'), 105, y, { align: 'center' });
            y += 10;
            pdf.setFontSize(10);
            pdf.setTextColor(100);
            pdf.text('EN 14960-1:2019', 105, y, { align: 'center' });
            y += 15;
            pdf.setFontSize(14);
            pdf.setTextColor(0);
            pdf.text(tr('basicInfo'), 20, y);
            y += 8;
            pdf.setFontSize(10);
            pdf.text(`${tr('length')}: ${app.data.length} m | ${tr('width')}: ${app.data.width} m | ${tr('height')}: ${app.data.height} m`, 20, y);
            y += 6;
            pdf.text(`${tr('productId')}: ${app.data.productId || tr('missing')}`, 20, y);
            y += 10;
            if (app.result) {
                pdf.setFontSize(16);
                const statusColor = app.result.ok ? [34, 197, 94] : [220, 38, 38];
                pdf.setTextColor(...statusColor);
                pdf.text(app.result.ok ? tr('approved') : tr('failed'), 20, y);
                y += 10;
                if (app.result.issues.length > 0) {
                    pdf.setFontSize(12);
                    pdf.setTextColor(0);
                    pdf.text(app.lang === 'sv' ? 'Avvikelser:' : 'Issues:', 20, y);
                    y += 8;
                    pdf.setFontSize(10);
                    app.result.issues.forEach(issue => {
                        if (y > 270) { pdf.addPage(); y = 20; }
                        const color = issue.severity === 'critical' ? [220, 38, 38] : issue.severity === 'serious' ? [249, 115, 22] : [234, 179, 8];
                        pdf.setTextColor(...color);
                        pdf.text(`‚Ä¢ ${issue.cat}: ${issue.msg}`, 25, y);
                        y += 5;
                        pdf.setTextColor(100);
                        pdf.setFontSize(8);
                        pdf.text(`  ${tr('reference')} ${issue.ref}`, 25, y);
                        y += 4;
                        pdf.text(`  ${tr('action')} ${issue.action}`, 25, y);
                        y += 7;
                        pdf.setFontSize(10);
                    });
                }
            }
            const timestamp = new Date().toLocaleString(app.lang === 'sv' ? 'sv-SE' : 'en-GB');
            pdf.setFontSize(8);
            pdf.setTextColor(150);
            pdf.text(`${tr('generated')}: ${timestamp}`, 105, 287, { align: 'center' });
            pdf.save(`hoppborg-inspektion-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function render() {
            const c = calc();
            const d = app.data;
            
            document.getElementById('app').innerHTML = `
                <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg shadow-lg p-6 mb-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-sm opacity-90">EN 14960-1:2019</div>
                            <h1 class="text-3xl font-bold">${tr('title')}</h1>
                            <p class="text-sm mt-1 opacity-90">${tr('subtitle')}</p>
                        </div>
                        <button onclick="toggleLang()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                            üåç ${tr('langToggle')}
                        </button>
                    </div>
                </div>

                <!-- Grunduppgifter -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">üìè ${tr('basicInfo')}</h2>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">${tr('length')} * <button onclick="showInfo('length')" class="inline-block w-5 h-5 bg-blue-500 text-white rounded-full text-xs hover:bg-blue-600">?</button></label>
                            <input type="number" step="0.1" id="length" value="${d.length}" class="w-full p-2 border rounded">
                            <p class="text-xs text-gray-500 mt-1">${tr('edgeToEdgeLength')}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">${tr('width')} * <button onclick="showInfo('width')" class="inline-block w-5 h-5 bg-blue-500 text-white rounded-full text-xs hover:bg-blue-600">?</button></label>
                            <input type="number" step="0.1" id="width" value="${d.width}" class="w-full p-2 border rounded">
                            <p class="text-xs text-gray-500 mt-1">${tr('edgeToEdgeWidth')}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">${tr('height')} * <button onclick="showInfo('height')" class="inline-block w-5 h-5 bg-blue-500 text-white rounded-full text-xs hover:bg-blue-600">?</button></label>
                            <input type="number" step="0.1" id="height" value="${d.height}" class="w-full p-2 border rounded">
                            <p class="text-xs text-gray-500 mt-1">${tr('groundToWall')}</p>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4 mt-4">
                        <label class="flex items-center gap-2 mb-3">
                            <input type="checkbox" id="useIndividualHeights" ${d.useIndividualHeights?'checked':''} class="w-4 h-4">
                            <span class="text-sm font-semibold">üéØ ${tr('individualHeightsLabel')}</span>
                        </label>
                        <p class="text-xs text-gray-600 mb-3">${tr('individualHeightsHelp')}</p>
                        ${d.useIndividualHeights ? `
                        <div class="grid grid-cols-4 gap-3 bg-blue-50 p-3 rounded">
                            <div><label class="block text-xs font-medium mb-1">${tr('heightSideA')}</label>
                            <input type="number" step="0.1" id="heightA" value="${d.heightA}" class="w-full p-2 border rounded text-sm" placeholder="${d.height}"></div>
                            <div><label class="block text-xs font-medium mb-1">${tr('heightSideB')}</label>
                            <input type="number" step="0.1" id="heightB" value="${d.heightB}" class="w-full p-2 border rounded text-sm" placeholder="${d.height}"></div>
                            <div><label class="block text-xs font-medium mb-1">${tr('heightSideC')}</label>
                            <input type="number" step="0.1" id="heightC" value="${d.heightC}" class="w-full p-2 border rounded text-sm" placeholder="${d.height}"></div>
                            <div><label class="block text-xs font-medium mb-1">${tr('heightSideD')}</label>
                            <input type="number" step="0.1" id="heightD" value="${d.heightD}" class="w-full p-2 border rounded text-sm" placeholder="${d.height}"></div>
                        </div>` : ''}
                    </div>
                </div>

                <!-- Typ & konstruktion -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">üè∞ ${tr('typeConstruction')}</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-sm font-medium mb-1">${tr('type')} *</label>
                            <select id="type" class="w-full p-2 border rounded">
                                <option value="">${tr('selectType')}</option>
                                <option value="flatbed" ${d.type==='flatbed'?'selected':''}>${tr('typeFlatbed')}</option>
                                <option value="castle" ${d.type==='castle'?'selected':''}>${tr('typeCastle')}</option>
                                <option value="aframe" ${d.type==='aframe'?'selected':''}>${tr('typeAframe')}</option>
                                <option value="combo" ${d.type==='combo'?'selected':''}>${tr('typeCombo')}</option>
                                <option value="multiplay" ${d.type==='multiplay'?'selected':''}>${tr('typeMultiplay')}</option>
                                <option value="obstacle" ${d.type==='obstacle'?'selected':''}>${tr('typeObstacle')}</option>
                                <option value="slide" ${d.type==='slide'?'selected':''}>${tr('typeSlide')}</option>
                                <option value="enclosed" ${d.type==='enclosed'?'selected':''}>${tr('typeEnclosed')}</option>
                                <option value="softmountain" ${d.type==='softmountain'?'selected':''}>${tr('typeSoftmountain')}</option>
                            </select>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">${tr('platformHeight')}</label>
                            <input type="number" step="0.1" id="platformHeight" value="${d.platformHeight}" class="w-full p-2 border rounded">
                            <p class="text-xs text-gray-500 mt-1">${tr('platformHeightHelp')}</p>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">${tr('wallHeight')}</label>
                            <input type="number" step="0.1" id="wallHeight" value="${d.wallHeight}" class="w-full p-2 border rounded">
                            <p class="text-xs text-gray-500 mt-1">${tr('wallHeightHelp')}</p>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">${tr('hasSlide')}</label>
                            <select id="hasSlide" class="w-full p-2 border rounded">
                                <option value="">${tr('selectOption')}</option>
                                <option value="yes" ${d.hasSlide==='yes'?'selected':''}>${tr('yes')}</option>
                                <option value="no" ${d.hasSlide==='no'?'selected':''}>${tr('no')}</option>
                            </select>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">${tr('hasRopes')}</label>
                            <select id="hasRopes" class="w-full p-2 border rounded">
                                <option value="">${tr('selectOption')}</option>
                                <option value="no" ${d.hasRopes==='no'?'selected':''}>${tr('no')}</option>
                                <option value="yes" ${d.hasRopes==='yes'?'selected':''}>${tr('yes')}</option>
                            </select>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">${tr('hasNetting')}</label>
                            <select id="hasNetting" class="w-full p-2 border rounded">
                                <option value="">${tr('selectOption')}</option>
                                <option value="yes" ${d.hasNetting==='yes'?'selected':''}>${tr('yes')}</option>
                                <option value="no" ${d.hasNetting==='no'?'selected':''}>${tr('no')}</option>
                            </select>
                        </div>
                        ${d.hasNetting === 'yes' ? `
                        <div><label class="block text-sm font-medium mb-1">${tr('meshSize')}</label>
                            <input type="number" id="nettingMesh" value="${d.nettingMesh}" class="w-full p-2 border rounded" placeholder="${tr('meshPlaceholder')}">
                        </div>
                        <div><label class="block text-sm font-medium mb-1">${tr('reachesCorners')} <button onclick="showInfo('corners')" class="inline-block w-5 h-5 bg-blue-500 text-white rounded-full text-xs hover:bg-blue-600">?</button></label>
                            <select id="nettingCorners" class="w-full p-2 border rounded">
                                <option value="">${tr('selectOption')}</option>
                                <option value="yes" ${d.nettingCorners==='yes'?'selected':''}>${tr('yes')}</option>
                                <option value="no" ${d.nettingCorners==='no'?'selected':''}>${tr('no')}</option>
                            </select>
                        </div>` : ''}
                    </div>
                </div>

                <!-- Slide -->
                ${d.hasSlide === 'yes' ? `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6 border-l-4 border-purple-500">
                    <h2 class="text-xl font-bold mb-4">üõù ${tr('slide')}</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium mb-1">${tr('slideHeight')}</label>
                            <input type="number" step="0.1" id="slideHeight" value="${d.slideHeight}" class="w-full p-2 border rounded">
                        </div>
                        <div><label class="block text-sm font-medium mb-1">${tr('runoutLength')}</label>
                            <input type="number" step="0.1" id="runoutLength" value="${d.runoutLength}" class="w-full p-2 border rounded">
                            <p class="text-xs text-gray-500 mt-1">${tr('minRunout')}</p>
                        </div>
                        <div class="col-span-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="hasStopWall" ${d.hasStopWall?'checked':''} class="w-4 h-4">
                                <span class="text-sm font-medium">${tr('hasStopWall')}</span>
                            </label>
                        </div>
                    </div>
                    ${c ? `<div class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-500 rounded">
                        <p class="text-sm font-semibold">üßÆ ${tr('calculatedRunout')}</p>
                        <p class="text-sm">${tr('requirement')} <strong>${c.runoutRequired.toFixed(2)} m</strong></p>
                    </div>` : ''}
                </div>` : ''}

                <!-- Trappa -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">üö™ ${tr('entranceRef')}</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium mb-1">${tr('entranceHeight')}</label>
                            <input type="number" step="0.1" id="entranceHeight" value="${d.entranceHeight}" class="w-full p-2 border rounded">
                            <p class="text-xs text-gray-500 mt-1">${tr('entranceHeightHelp')}</p>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">${tr('treadDepth')}</label>
                            <input type="number" step="0.1" id="entranceTreadDepth" value="${d.entranceTreadDepth}" class="w-full p-2 border rounded">
                            <p class="text-xs text-gray-500 mt-1">${tr('minTreadDepth')}</p>
                        </div>
                    </div>
                    ${c && c.minTreadDepth > 0 ? `<div class="mt-3 p-2 bg-blue-50 rounded text-sm">
                        <p class="font-semibold">${tr('calculatedFromPlatform')} (${app.data.platformHeight}m):</p>
                        <p>${tr('minimumTreadDepth')} <strong>${c.minTreadDepth.toFixed(2)} m</strong></p>
                    </div>` : ''}
                </div>

                <!-- F√∂rankring -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        ‚öì ${tr('anchoringTitle')}
                        <button onclick="showInfo('annexA')" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">${tr('annexAExplanation')}</button>
                    </h2>
                    ${c && c.L && c.W ? `<div class="mb-4 p-4 bg-blue-50 rounded">
                        <div class="text-center font-semibold mb-2">${tr('anchorPointsOverview')}</div>
                        <svg viewBox="0 0 ${c.L * 40} ${c.W * 40}" class="w-full max-w-md mx-auto border-2 border-blue-500 bg-white rounded">
                            <rect x="0" y="0" width="${c.L * 40}" height="${c.W * 40}" fill="#eff6ff" stroke="#3b82f6" stroke-width="2"/>
                            <text x="${c.L * 20}" y="20" text-anchor="middle" font-weight="bold" fill="#1e40af">${tr('sideLabel')} A</text>
                            <text x="${c.L * 40 - 10}" y="${c.W * 20}" text-anchor="end" font-weight="bold" fill="#1e40af" transform="rotate(-90 ${c.L * 40 - 10} ${c.W * 20})">B</text>
                            <text x="${c.L * 20}" y="${c.W * 40 - 5}" text-anchor="middle" font-weight="bold" fill="#1e40af">${tr('sideLabel')} C</text>
                            <text x="10" y="${c.W * 20}" font-weight="bold" fill="#1e40af" transform="rotate(-90 10 ${c.W * 20})">D</text>
                        </svg>
                    </div>` : ''}
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        ${c ? ['A', 'B', 'C', 'D'].map(s => `
                        <div>
                            <label class="block text-sm font-medium mb-1">${tr('sideLabel')} ${s}: ${tr('anchorPoints')}
                                <span class="text-xs text-gray-500">(${tr('requirementShort')} ${c.anchors[s].need} ${tr('stShort')} ${tr('atHeight')}${c.anchors[s].height.toFixed(1)}${tr('heightShort')})</span>
                            </label>
                            <input type="number" id="anchor${s}" value="${d['anchor'+s]}" class="w-full p-2 border rounded">
                            ${d.useIndividualHeights ? `<p class="text-xs text-blue-600 mt-1">${tr('heightLabel')} ${c.anchors[s].height.toFixed(1)}m √ó ${c.anchors[s].len}m = ${(c.anchors[s].len * c.anchors[s].height).toFixed(1)}m¬≤ ${tr('areaLabel')}</p>` : ''}
                        </div>`).join('') : ''}
                        <div><label class="block text-sm font-medium mb-1">${tr('anchorAngle')}</label>
                            <input type="number" id="anchorAngle" value="${d.anchorAngle}" class="w-full p-2 border rounded" placeholder="${tr('anchorAnglePlaceholder')}">
                        </div>
                    </div>
                    <button onclick="app.cameraActive ? stopCamera() : startCamera()" 
                        class="w-full flex items-center justify-center gap-2 py-3 rounded-lg font-medium mb-4 ${app.cameraActive ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}">
                        ${app.cameraActive ? tr('closeCamera') : tr('openCamera')}
                    </button>
                    ${app.cameraActive ? `
                    <div class="mb-6 relative bg-black rounded-lg overflow-hidden">
                        <video id="cam" autoplay playsinline class="w-full"></video>
                        <svg class="absolute inset-0 w-full h-full pointer-events-none" viewBox="0 0 100 100" preserveAspectRatio="none">
                            <line x1="0" y1="80" x2="100" y2="80" stroke="#22c55e" stroke-width="0.5" stroke-dasharray="2,2"/>
                            <line x1="50" y1="80" x2="85" y2="60" stroke="#fbbf24" stroke-width="0.8"/>
                            <text x="70" y="58" fill="#fbbf24" font-size="4" font-weight="bold">30¬∞</text>
                            <line x1="50" y1="80" x2="80" y2="50" stroke="#ef4444" stroke-width="0.8"/>
                            <text x="65" y="48" fill="#ef4444" font-size="4" font-weight="bold">45¬∞</text>
                            <path d="M 50 80 L 85 60 L 80 50 Z" fill="#22c55e" opacity="0.2"/>
                            <circle cx="50" cy="80" r="2" fill="#22c55e"/>
                        </svg>
                    </div>` : ''}
                </div>

                <!-- Lufttryck -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">üí® ${tr('airPressure')}</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium mb-1">${tr('blowersCount')}</label>
                            <input type="number" id="blowersNeeded" value="${d.blowersNeeded}" class="w-full p-2 border rounded">
                            ${c ? `<p class="text-xs text-gray-500 mt-1">${tr('calculated')} ${c.blowersNeeded} ${tr('stShort')}</p>` : ''}
                        </div>
                        <div><label class="block text-sm font-medium mb-1">${tr('blowerPower')}</label>
                            <input type="number" id="blowerPower" value="${d.blowerPower}" class="w-full p-2 border rounded" placeholder="${tr('powerPlaceholder')}">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1">${tr('blowerTubeLength')} *</label>
                            <input type="number" step="0.1" id="blowerTubeLength" value="${d.blowerTubeLength}" class="w-full p-2 border rounded">
                            <div class="mt-2 space-y-1">
                                <p class="text-xs text-red-600 font-semibold">${tr('tubeLengthWarning')}</p>
                                <p class="text-xs text-green-600 font-semibold">${tr('tubeLengthRecommended')}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- M√§rkning -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">üè∑Ô∏è ${tr('marking')}</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium mb-1">${tr('productId')} *</label>
                            <input type="text" id="productId" value="${d.productId}" class="w-full p-2 border rounded">
                        </div>
                        <div><label class="block text-sm font-medium mb-1">${tr('idVisible')}</label>
                            <select id="idVisible" class="w-full p-2 border rounded">
                                <option value="">${tr('selectOption')}</option>
                                <option value="yes" ${d.idVisible==='yes'?'selected':''}>${tr('yes')}</option>
                                <option value="no" ${d.idVisible==='no'?'selected':''}>${tr('no')}</option>
                            </select>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">${tr('maxUsers')}</label>
                            <input type="number" id="manufacturerMaxUsers" value="${d.manufacturerMaxUsers}" class="w-full p-2 border rounded">
                        </div>
                        <div><label class="block text-sm font-medium mb-1">${tr('maxUserHeight')}</label>
                            <input type="number" step="0.1" id="manufacturerUserHeight" value="${d.manufacturerUserHeight}" class="w-full p-2 border rounded">
                        </div>
                        <div class="col-span-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="hasSafetyInstructions" ${d.hasSafetyInstructions?'checked':''} class="w-4 h-4">
                                <span class="text-sm font-medium">${tr('hasSafetyInst')}</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Bilder -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">üì∏ ${tr('images')}</h2>
                    <label class="block w-full cursor-pointer bg-orange-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-orange-700 text-center mb-4">
                        ${tr('addImage')}
                        <input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden">
                    </label>
                    ${d.images.length > 0 ? `
                    <div class="grid grid-cols-2 gap-4">
                        ${d.images.map((img, i) => `
                            <div class="relative border rounded-lg overflow-hidden">
                                <img src="${img.data}" class="w-full h-32 object-cover">
                                <button onclick="removeImage(${i})" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-lg">√ó</button>
                                <div class="p-2 bg-gray-50 text-xs truncate">${img.name}</div>
                            </div>
                        `).join('')}
                    </div>` : ''}
                </div>

                <button onclick="validate()" class="w-full bg-blue-600 text-white py-4 rounded-lg text-lg font-bold hover:bg-blue-700 mb-6">
                    ${tr('validate')}
                </button>

                <!-- Resultat -->
                ${app.result ? `
                <div class="space-y-6">
                    <div class="rounded-lg shadow-lg p-6 border-l-8 ${app.result.ok ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}">
                        <h3 class="text-2xl font-bold">${app.result.ok ? tr('approved') : tr('failed')}</h3>
                        <p>${app.result.issues.length} ${tr('totalIssues')}</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4">üìä ${tr('summary')}</h3>
                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <div class="bg-gray-50 p-4 rounded text-center">
                                <div class="text-3xl font-bold text-gray-600">${app.result.issues.length}</div>
                                <div class="text-sm">${tr('total')}</div>
                            </div>
                            <div class="bg-red-50 p-4 rounded text-center">
                                <div class="text-3xl font-bold text-red-600">${app.result.critical.length}</div>
                                <div class="text-sm">${tr('critical')}</div>
                            </div>
                            <div class="bg-orange-50 p-4 rounded text-center">
                                <div class="text-3xl font-bold text-orange-600">${app.result.serious.length}</div>
                                <div class="text-sm">${tr('serious')}</div>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded text-center">
                                <div class="text-3xl font-bold text-yellow-600">${app.result.warnings.length}</div>
                                <div class="text-sm">${tr('warnings')}</div>
                            </div>
                        </div>

                        <h4 class="font-bold mb-3">${tr('reqVsMeasured')}</h4>
                        <div class="overflow-x-auto mb-6">
                            <table class="w-full text-sm border-collapse">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 text-left border">${tr('parameter')}</th>
                                        <th class="p-2 text-left border">${tr('required')}</th>
                                        <th class="p-2 text-left border">${tr('measured')}</th>
                                        <th class="p-2 text-center border">${tr('status')}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${['A', 'B', 'C', 'D'].map(s => {
                                        const req = c.anchors[s].need;
                                        const supplied = parseInt(d['anchor'+s]) || 0;
                                        const ok = supplied >= req;
                                        return `
                                        <tr class="${ok ? '' : 'bg-red-50'}">
                                            <td class="p-2 border">${tr('anchorSide')} ${s}</td>
                                            <td class="p-2 border">${req} ${tr('stShort')}</td>
                                            <td class="p-2 border">${supplied} ${tr('stShort')}</td>
                                            <td class="p-2 text-center border"><span class="${ok ? 'text-green-600' : 'text-red-600'}">${ok ? '‚úì' : '‚úó'}</span></td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>

                        ${app.result.critical.length > 0 ? `
                        <h4 class="font-bold text-red-900 mb-3">${tr('criticalIssues')}</h4>
                        <div class="space-y-3 mb-6">
                            ${app.result.critical.map(i => `
                                <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded">
                                    <div class="font-semibold">${i.cat}</div>
                                    <div class="text-sm">${i.msg}</div>
                                    <div class="text-xs text-gray-600 mt-1">${tr('reference')} ${i.ref}</div>
                                    <div class="text-xs text-red-800 mt-2"><strong>${tr('action')}</strong> ${i.action}</div>
                                </div>
                            `).join('')}
                        </div>` : ''}

                        ${app.result.serious.length > 0 ? `
                        <h4 class="font-bold text-orange-900 mb-3">${tr('seriousIssues')}</h4>
                        <div class="space-y-3 mb-6">
                            ${app.result.serious.map(i => `
                                <div class="border-l-4 border-orange-500 bg-orange-50 p-4 rounded">
                                    <div class="font-semibold">${i.cat}</div>
                                    <div class="text-sm">${i.msg}</div>
                                    <div class="text-xs text-gray-600 mt-1">${tr('reference')} ${i.ref}</div>
                                    <div class="text-xs text-orange-800 mt-2"><strong>${tr('action')}</strong> ${i.action}</div>
                                </div>
                            `).join('')}
                        </div>` : ''}

                        ${app.result.warnings.length > 0 ? `
                        <h4 class="font-bold text-yellow-900 mb-3">${tr('warningIssues')}</h4>
                        <div class="space-y-3 mb-6">
                            ${app.result.warnings.map(i => `
                                <div class="border-l-4 border-yellow-500 bg-yellow-50 p-4 rounded">
                                    <div class="font-semibold">${i.cat}</div>
                                    <div class="text-sm">${i.msg}</div>
                                    <div class="text-xs text-gray-600 mt-1">${tr('reference')} ${i.ref}</div>
                                    <div class="text-xs text-yellow-800 mt-2"><strong>${tr('action')}</strong> ${i.action}</div>
                                </div>
                            `).join('')}
                        </div>` : ''}
                    </div>

                    <div class="flex gap-3">
                        <button onclick="exportPDF()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700">
                            ${tr('savePdf')}
                        </button>
                        <button onclick="app.result=null; render()" class="flex-1 bg-gray-600 text-white py-3 rounded-lg font-medium hover:bg-gray-700">
                            ${tr('newValidation')}
                        </button>
                    </div>
                </div>` : ''}
            `;

            // Event listeners
            ['length','width','height','heightA','heightB','heightC','heightD','type','platformHeight','wallHeight','hasSlide','slideHeight',
             'runoutLength','entranceHeight','entranceTreadDepth','anchorA','anchorB','anchorC','anchorD',
             'anchorAngle','blowersNeeded','blowerPower','blowerTubeLength','productId','idVisible',
             'manufacturerMaxUsers','manufacturerUserHeight','hasRopes','hasNetting','nettingMesh','nettingCorners'].forEach(f => {
                const el = document.getElementById(f);
                if (el) el.addEventListener('change', e => { app.data[f] = e.target.value; render(); });
            });

            ['hasSafetyInstructions', 'hasStopWall', 'useIndividualHeights'].forEach(f => {
                const el = document.getElementById(f);
                if (el) el.addEventListener('change', e => { app.data[f] = e.target.checked; render(); });
            });

            const imgInput = document.getElementById('imageInput');
            if (imgInput) {
                imgInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) addImage(file);
                });
            }
        }

        // Initial render
        const saved = localStorage.getItem('hoppborg');
        if (saved) {
            const parsed = JSON.parse(saved);
            app.data = parsed.data || app.data;
        }
        render();
    </script>
</body>
</html>
